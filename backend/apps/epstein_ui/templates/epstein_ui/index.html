{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Epstein Studio</title>
    <link rel="icon" href="{% static 'epstein_ui/favicon.ico' %}" type="image/x-icon" />
    <link rel="stylesheet" href="{% static 'epstein_ui/style.css' %}" />
  </head>
  <body data-auth="{% if user.is_authenticated %}1{% else %}0{% endif %}" data-user="{% if user.is_authenticated %}{{ user.username }}{% endif %}" data-target-hash="{% if target_hash %}{{ target_hash }}{% endif %}">
    <div class="page">
      <div id="contextMenu" class="context-menu">
        <button data-action="edit">Edit</button>
        <button data-action="delete">Delete</button>
      </div>
      <div id="confirmOverlay" class="confirm-overlay hidden">
        <div class="confirm-dialog">
          <div class="confirm-title">Delete comment?</div>
          <div class="confirm-text">This will delete the comment and all replies.</div>
          <div class="confirm-actions">
            <button id="confirmCancel" class="btn btn-outline" type="button">Cancel</button>
            <button id="confirmOk" class="btn" type="button">Delete</button>
          </div>
        </div>
      </div>
      <header class="topbar">
        <div class="topbar-row">
          <div class="brand">Epstein Studio</div>
          <div class="topbar-actions">
            {% if user.is_authenticated %}
              <a class="btn btn-secondary" href="/about/">About</a>
              <details class="account-menu">
                <summary class="account-button" aria-label="Account menu">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="12" cy="8" r="4"></circle>
                    <path d="M4 20c1.7-3.6 5-6 8-6s6.3 2.4 8 6"></path>
                  </svg>
                  <span class="notif-dot hidden" aria-hidden="true"></span>
                </summary>
                <div class="account-dropdown">
                  <div class="account-username">{{ user.username }}</div>
                  <a class="account-link" href="/notifications/">
                    Notifications
                    <span class="notif-dot hidden" aria-hidden="true"></span>
                  </a>
                  <a class="account-link" href="/logout/">Logout</a>
                </div>
              </details>
            {% else %}
              <a class="btn btn-secondary" href="/about/">About</a>
              <a class="btn" href="/login/">Participate</a>
            {% endif %}
          </div>
        </div>
      </header>

      <main class="layout">
        <section class="panel annotation-panel">
          {% if not user.is_authenticated %}
            <div class="hint">Create unique anonymous ID to participate</div>
          {% endif %}
          <div class="annotation-actions">
            <button id="createAnnotationBtn" class="btn">Create Annotation</button>
          </div>
          <div id="annotationPrompt" class="hint hidden">
            Click on the canvas to place a new annotation.
          </div>
          <div id="pdfCommentForm" class="pdf-comment-form">
            <textarea id="pdfCommentInput" rows="3" placeholder="Add a comment..."></textarea>
            <button id="pdfCommentSubmit" class="btn btn-secondary" type="button">Post Comment</button>
            <div id="pdfCommentLoginHint" class="discussion-hint hidden">Login to comment.</div>
          </div>
          <div class="annotation-section-row">
            <div id="annotationNotesTitle" class="annotation-section-title hidden">Comments and Annotations</div>
            <div id="annotationSort" class="annotation-sort hidden">
              <select id="annotationSortSelect">
                <option value="date" selected>Date</option>
                <option value="upvotes">Upvotes</option>
                <option value="mine">Mine only</option>
              </select>
            </div>
          </div>
          <div id="annotationNotes" class="annotation-notes"></div>
          <div id="annotationStatus" class="annotation-status hidden">Annotations Loading...</div>
          <div id="annotationControls" class="annotation-controls hidden">
            <div class="tabs" id="annotationTabs">
              <button class="tab active tab-notes" data-tab="notes">Note</button>
              <button class="tab tab-text" data-tab="text">Text</button>
              <button class="tab tab-hints" data-tab="hints">Hints</button>
            </div>
            <div class="tab-panel active" data-panel="notes">
              <div id="annotationViewHeader" class="annotation-view-header hidden">
                <div id="annotationViewTitle" class="annotation-view-title"></div>
                <div id="annotationViewMeta" class="annotation-view-meta">
                  <button id="annotationViewCopy" class="copy-link-btn" type="button" title="Copy link">
                    <img src="/static/epstein_ui/icons/link.svg" alt="Copy link" />
                  </button>
                </div>
              </div>
              <div id="annotationViewNote" class="annotation-view-note hidden"></div>
              <div id="annotationViewActions" class="annotation-view-actions hidden">
                <div class="annotation-view-votes">
                  <button id="annotationViewUp" class="vote-btn up" type="button">
                    <img class="vote-icon" src="/static/epstein_ui/icons/arrow-big-up.svg" alt="" />
                  </button>
                  <button id="annotationViewDown" class="vote-btn down" type="button">
                    <img class="vote-icon" src="/static/epstein_ui/icons/arrow-big-down.svg" alt="" />
                  </button>
                  <span id="annotationViewScore" class="vote-score">0</span>
                </div>
                <button id="annotationViewBack" class="btn btn-outline" type="button">Back</button>
              </div>
              <div id="discussionPanel" class="discussion-panel hidden">
                <div class="discussion-body">
                  <div class="discussion-title">Discussion</div>
                  <div id="discussionList" class="discussion-list"></div>
                  <div id="discussionForm" class="discussion-form">
                    <textarea id="discussionInput" rows="3" placeholder="Add a comment..."></textarea>
                    <button id="discussionSubmit" class="btn btn-secondary" type="button">Comment</button>
                  </div>
                  <div id="discussionLoginHint" class="discussion-hint hidden">Login to comment or vote.</div>
                </div>
                <div class="discussion-actions">
                  <button id="discussionEditBtn" class="btn hidden" type="button">Edit Annotation</button>
                </div>
              </div>
              <label class="field">
                <div class="hint">Explain your annotation (optional).</div>
                <textarea id="notesInput" rows="8" placeholder="&quot;This Redaction is interesting, because...&quot;"></textarea>
              </label>
            </div>
            <div class="tab-panel" data-panel="text">
              <div class="hint">Click to create a text box. Click a box to edit it.</div>
              <label class="field">
                <span>Font</span>
                <select id="fontSelect">
                  <option value="'Calibri', 'Segoe UI', sans-serif" selected>Calibri</option>
                  <option value="'Times New Roman', serif">Times New Roman</option>
                  <option value="'Cambria', serif">Cambria</option>
                  <option value="'Arial', sans-serif">Arial</option>
                  <option value="'Courier New', monospace">Courier New</option>
                </select>
              </label>
              <div class="field">
                <span>Style</span>
                <div class="toggle-row">
                  <button id="boldToggle" class="btn btn-secondary" type="button">Bold</button>
                  <button id="italicToggle" class="btn btn-secondary" type="button">Italic</button>
                </div>
              </div>
              <label class="field">
                <span>Size</span>
                <div class="size-row">
                  <input id="sizeRange" type="range" min="10" max="40" value="14.7" step="0.01" />
                  <input id="sizeInput" type="number" min="10" max="40" step="0.01" value="14.7" />
                </div>
              </label>
              <label class="field">
                <span>Kerning</span>
                <div class="toggle-row">
                  <button id="kerningToggle" class="btn btn-secondary" type="button">Off</button>
                </div>
              </label>
              <label class="field">
                <span>Ligatures</span>
                <div class="toggle-row">
                  <button id="ligatureToggle" class="btn btn-secondary" type="button">Off</button>
                </div>
              </label>
              <div class="field">
                <span>Color</span>
                <button id="colorSwatch" class="btn btn-secondary" type="button" aria-label="Pick color">
                  <span class="swatch-letter">A</span>
                </button>
                <input id="colorPicker" type="color" value="#39ff14" />
              </div>
              <label class="field">
                <span>Opacity</span>
                <input id="opacityRange" type="range" min="30" max="100" value="100" />
              </label>
            </div>
            <div class="tab-panel" data-panel="hints">
              <div class="hint">Click twice to draw a red arrow. Select an arrow to edit handles.</div>
            </div>
            <div class="annotation-actions">
              <button id="commitAnnotationBtn" class="btn">Commit Annotation</button>
              <button id="discardAnnotationBtn" class="btn btn-outline">Delete Annotation</button>
            </div>
          </div>
        </section>

        <section class="canvas-wrap">
          <div class="canvas-header">
            <div>
              <div class="file-title-row">
                <div class="file-title" id="fileTitle">No file loaded</div>
                <div class="pdf-vote-frame">
                  <button id="pdfVoteUp" class="pdf-vote-btn up" type="button">
                    <img src="{% static 'epstein_ui/icons/thumbs-up.svg' %}" alt="" />
                    <span>Promising</span>
                  </button>
                  <button id="pdfVoteDown" class="pdf-vote-btn down" type="button">
                    <img src="{% static 'epstein_ui/icons/thumbs-down.svg' %}" alt="" />
                    <span>Not Promising</span>
                  </button>
                  <span id="pdfVoteScore" class="pdf-vote-score">0</span>
                </div>
              </div>
            </div>
            <div class="header-actions">
              <div class="search-wrap">
                <input id="searchInput" type="text" placeholder="Search PDF File..." list="pdfSuggestions" />
                <datalist id="pdfSuggestions"></datalist>
                <button id="searchBtn" class="btn btn-secondary">Open</button>
              </div>
              <a id="browseBtn" class="btn btn-secondary" href="/browse/">Browse</a>
            </div>
          </div>
          <div class="canvas-body">
            <div class="canvas">
            <canvas id="heatmapCanvas" aria-hidden="true"></canvas>
            <svg id="overlay" viewBox="0 0 900 520" role="img" aria-label="Redaction overlay canvas">
              <defs>
                <marker id="arrowhead" markerWidth="5" markerHeight="3.5" refX="4.5" refY="1.75" orient="auto">
                  <polygon points="0 0, 5 1.75, 0 3.5" fill="#ff2d2d"></polygon>
                </marker>
              </defs>
              <g id="viewport" transform="translate(0 0) scale(1)">
                <g id="pdfPages"></g>
                <g id="hintLayer"></g>
                <g id="textLayer"></g>
              </g>
            </svg>
            </div>
            <aside class="minimap">
              <div class="minimap-title">Overview</div>
              <div class="minimap-scroll">
                <svg id="minimapSvg" viewBox="0 0 900 520" preserveAspectRatio="xMinYMin meet">
                  <g id="minimapPages"></g>
                  <image id="minimapHeatmap" x="0" y="0" />
                  <rect id="minimapViewport" x="0" y="0" width="100" height="100" rx="6" />
                </svg>
              </div>
              <div class="minimap-actions">
                <label class="minimap-label">Move to Page</label>
                <div class="minimap-controls">
                  <input id="minimapPageInput" type="number" min="1" step="1" value="1" />
                  <button id="minimapJump" class="btn btn-secondary">Current View</button>
                </div>
              </div>
              <div class="minimap-hint">Scroll to zoom, drag to pan.</div>
            </aside>
          </div>
          <div class="hint">Tip: Ctrl + drag or middle mouse to pan. Wheel to zoom. Shift snaps size steps.</div>
        </section>
      </main>
    </div>
    <a class="coffee-link" href="https://buymeacoffee.com/artischocki" target="_blank" rel="noopener">Support this project</a>

    <script src="{% static 'epstein_ui/app.js' %}?v=2"></script>
  </body>
</html>
