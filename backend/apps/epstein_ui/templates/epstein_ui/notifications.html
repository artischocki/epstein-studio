{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Epstein Studio Notifications</title>
    <link rel="icon" href="{% static 'epstein_ui/favicon.ico' %}" type="image/x-icon" />
    <link rel="stylesheet" href="{% static 'epstein_ui/style.css' %}" />
  </head>
  <body>
    <div class="page">
      <header class="topbar">
        <div class="topbar-row">
          <a href="/" class="brand">Epstein Studio</a>
          <a class="btn" href="/">Back</a>
        </div>
      </header>
      <main class="layout notifications-layout">
        <section class="panel">
          <div class="annotation-section-title">Notifications</div>
          <div class="notifications-list">
            {% for notif in notifications %}
              <a class="notification-card{% if not notif.is_read %} unread{% endif %}" data-id="{{ notif.id }}" href="{{ notif.target_url }}">
                <div class="notification-meta">
                  {% if not notif.is_read %}
                    <span class="notif-dot" aria-hidden="true"></span>
                  {% endif %}
                  {% if notif.type == "annotation_reply" %}
                    <span>{{ notif.actor }} replied to your annotation "{{ notif.body|truncatechars:80 }}"</span>
                  {% else %}
                    <span>{{ notif.actor }} replied to your comment "{{ notif.body|truncatechars:80 }}"</span>
                  {% endif %}
                  <span class="notification-time">{{ notif.created_at|date:"M j, H:i" }}</span>
                </div>
                {% if notif.reply_body %}
                  <div class="notification-body">{{ notif.reply_body }}</div>
                {% endif %}
              </a>
            {% empty %}
              <div class="hint">No notifications yet.</div>
            {% endfor %}
          </div>
        </section>
      </main>
    </div>
    <script>
      document.querySelectorAll(".notification-card[data-id]").forEach((card) => {
        card.addEventListener("click", async () => {
          const id = card.getAttribute("data-id");
          if (!id) return;
          try {
            await fetch("/notifications-read/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id }),
            });
          } catch (err) {
            console.error(err);
          }
        });
      });
    </script>
  </body>
</html>
